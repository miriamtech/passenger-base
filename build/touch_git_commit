#!/usr/bin/env ruby
#
# Set a file's mtime to its git commit time. Recurses into any directories.
# This is useful in automated Docker builds where the build cache restoration process touches the file.
require 'open3'
require 'fileutils'

def touch(file)
  stdin, stdout, stderr = Open3::popen3("git log -n 1 --no-color --pretty=raw \"#{file}\"")
  while line = stdout.gets
    next unless line.match(/^committer .*? (\d+) ([\-\+]\d+)$/)
    time = Time.at($1.to_i)
  end
  FileUtils.touch file, :mtime => time
end

for file_or_directory in ARGV
  touch(file_or_directory)
  if File.directory?(file_or_directory)
    for file in Dir["#{file_or_directory}/**/*"]
      touch(file)
    end
  end
end